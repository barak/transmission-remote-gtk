From: "Barak A. Pearlmutter" <barak+git@pearlmutter.net>
Date: Sat, 9 Apr 2022 21:41:29 +0100
Subject: libayatana-appindicator

---
 README.md                    |  2 +-
 meson.build                  |  4 +++-
 meson_options.txt            |  1 +
 src/trg-main-window.c        | 16 +++++++++-------
 src/trg-preferences-dialog.c |  2 +-
 5 files changed, 15 insertions(+), 10 deletions(-)

diff --git a/README.md b/README.md
index b7564d6..e814003 100644
--- a/README.md
+++ b/README.md
@@ -29,7 +29,7 @@ The following packages are optional dependencies:
  - libmrss >= 0.18, RSS feed support
  - libproxy, HTTP proxy support
  - libgeoip, country of origin of peers
- - libappindicator, Application tray support
+ - libappindicator or libayatana-appindicator3, Application tray support
 
 If these libraries are installed at build time they will be automatically
 detected and linked for additional functionality.
diff --git a/meson.build b/meson.build
index c51e553..61c23df 100644
--- a/meson.build
+++ b/meson.build
@@ -49,8 +49,9 @@ rss_dep             = dependency('mrss', version: '>=0.18', required: get_option
 geoip_dep           = dependency('geoip', required: get_option('geoip'))
 libproxy_dep        = dependency('libproxy-1.0', required: get_option('libproxy'))
 libappindicator_dep = dependency('appindicator3-0.1', required: get_option('libappindicator'))
+libayatana_appindicator_dep = dependency('ayatana-appindicator3-0.1', required: get_option('libayatana-appindicator'))
 
-trg_deps += [geoip_dep, libproxy_dep, libappindicator_dep]
+trg_deps += [geoip_dep, libproxy_dep, libappindicator_dep, libayatana_appindicator_dep]
 
 # compiler
 cc = meson.get_compiler('c')
@@ -89,6 +90,7 @@ conf_data.set10('HAVE_GEOIP', geoip_dep.found())
 conf_data.set10('HAVE_LIBPROXY', libproxy_dep.found())
 conf_data.set10('ENABLE_NL_LANGINFO', nl_langinfo)
 conf_data.set10('HAVE_LIBAPPINDICATOR', libappindicator_dep.found())
+conf_data.set10('HAVE_LIBAYATANA_APPINDICATOR', libayatana_appindicator_dep.found())
 
 # compiler/linker flags
 flags = ['-funsigned-char',
diff --git a/meson_options.txt b/meson_options.txt
index d6eec64..7259d25 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -2,4 +2,5 @@ option('mrss', type: 'feature', value: 'auto', description: 'RSS support')
 option('libproxy', type: 'feature', value: 'auto', description: 'HTTP proxy support')
 option('geoip', type: 'feature', value: 'auto', description: 'geoip support')
 option('libappindicator', type: 'feature', value: 'auto', description: 'libappindicator')
+option('libayatana-appindicator', type: 'feature', value: 'auto', description: 'libayatana-appindicator')
 option('nl_langinfo', type: 'feature', value: 'auto', description: 'nl_langinfo() support')
diff --git a/src/trg-main-window.c b/src/trg-main-window.c
index f2c6ab3..a9d4fac 100644
--- a/src/trg-main-window.c
+++ b/src/trg-main-window.c
@@ -34,6 +34,8 @@
 #include <curl/curl.h>
 #if HAVE_LIBAPPINDICATOR
 #include <libappindicator/app-indicator.h>
+#elif HAVE_LIBAYATANA_APPINDICATOR
+#include <libayatana-appindicator/app-indicator.h>
 #endif
 
 #include "trg-client.h"
@@ -181,7 +183,7 @@ static GtkWidget *limit_menu_new(TrgMainWindow * win, gchar * title,
 static void trg_torrent_tv_view_menu(GtkWidget * treeview,
                                      GdkEventButton * event,
                                      TrgMainWindow * win);
-#if HAVE_LIBAPPINDICATOR
+#if HAVE_LIBAPPINDICATOR || HAVE_LIBAYATANA_APPINDICATOR
 static GtkMenu *trg_tray_view_menu(TrgMainWindow * win, const gchar * msg);
 #endif
 static gboolean torrent_tv_button_pressed_cb(GtkWidget * treeview,
@@ -207,7 +209,7 @@ typedef struct
     TrgStatusBar *statusBar;
     GtkWidget *iconStatusItem, *iconDownloadingItem, *iconSeedingItem,
         *iconSepItem;
-#if HAVE_LIBAPPINDICATOR
+#if HAVE_LIBAPPINDICATOR || HAVE_LIBAYATANA_APPINDICATOR
     AppIndicator *appIndicator;
 #endif
     TrgStateSelector *stateSelector;
@@ -1163,7 +1165,7 @@ TRANSMISSION_MIN_SUPPORTED, version);
 static void
 connchange_whatever_tray(TrgMainWindow * win, gboolean connected)
 {
-#if HAVE_LIBAPPINDICATOR
+#if HAVE_LIBAPPINDICATOR || HAVE_LIBAYATANA_APPINDICATOR
     TrgMainWindowPrivate *priv = trg_main_window_get_instance_private(win);
     TrgPrefs *prefs = trg_client_get_prefs(priv->client);
     gchar *display = connected ?
@@ -1184,7 +1186,7 @@ static void
 update_whatever_tray(TrgMainWindow * win,
                      trg_torrent_model_update_stats * stats)
 {
-#if HAVE_LIBAPPINDICATOR
+#if HAVE_LIBAPPINDICATOR || HAVE_LIBAYATANA_APPINDICATOR
     TrgMainWindowPrivate *priv = trg_main_window_get_instance_private(win);
 
     if (!priv->appIndicator)
@@ -2243,7 +2245,7 @@ trg_torrent_tv_view_menu(GtkWidget * treeview,
     gtk_menu_popup_at_pointer(GTK_MENU(menu), (GdkEvent *)event);
 }
 
-#if HAVE_LIBAPPINDICATOR
+#if HAVE_LIBAPPINDICATOR || HAVE_LIBAYATANA_APPINDICATOR
 static GtkMenu *trg_tray_view_menu(TrgMainWindow * win, const gchar * msg)
 {
     TrgMainWindowPrivate *priv = trg_main_window_get_instance_private(win);
@@ -2386,7 +2388,7 @@ static void trg_main_window_set_hidden_to_tray(TrgMainWindow * win,
 
 void trg_main_window_remove_tray(TrgMainWindow * win)
 {
-#if HAVE_LIBAPPINDICATOR
+#if HAVE_LIBAPPINDICATOR || HAVE_LIBAYATANA_APPINDICATOR
     TrgMainWindowPrivate *priv = trg_main_window_get_instance_private(win);
 
     if (priv->appIndicator)
@@ -2429,7 +2431,7 @@ void trg_main_window_remove_graph(TrgMainWindow * win)
 
 void trg_main_window_add_tray(TrgMainWindow * win)
 {
-#if HAVE_LIBAPPINDICATOR
+#if HAVE_LIBAPPINDICATOR || HAVE_LIBAYATANA_APPINDICATOR
     TrgMainWindowPrivate *priv = trg_main_window_get_instance_private(win);
 
     if (!priv->appIndicator) {
diff --git a/src/trg-preferences-dialog.c b/src/trg-preferences-dialog.c
index 6d5bd01..4693e5c 100644
--- a/src/trg-preferences-dialog.c
+++ b/src/trg-preferences-dialog.c
@@ -772,7 +772,7 @@ static GtkWidget *trg_prefs_viewPage(TrgPreferencesDialog * dlg)
     g_signal_connect(G_OBJECT(tray), "toggled", G_CALLBACK(toggle_tray_icon),
                      priv->win);
 
-    if (!HAVE_LIBAPPINDICATOR) {
+    if (!(HAVE_LIBAPPINDICATOR || HAVE_LIBAYATANA_APPINDICATOR)) {
         gtk_widget_set_sensitive(tray, FALSE);
         gtk_widget_set_tooltip_text(tray, _("System tray not supported."));
     }
